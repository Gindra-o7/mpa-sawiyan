---
import { ArrowUpRight } from "@lucide/astro";

// 1. Mendefinisikan tipe data untuk setiap slide menggunakan TypeScript
export interface Slide {
	gambar: string;
	label: string;
	cta_label: string;
	cta_url: string;
	colour: string;
}

// 2. Data slides hardcoded dengan tema kemanusiaan, agama, dan sosial
const slides: Slide[] = [
	{
		gambar: "https://images.unsplash.com/photo-1521791136064-7986c2920216?w=1920&h=1080&fit=crop",
		label: "Menjunjung tinggi <span class='text-brand-accent-gold'>kejujuran, amanah, dan tanggung jawab </span> dalam setiap aktivitas kelembagaan.",
		cta_label: "Integritas",
		cta_url: "/program",
		colour: "#FFD700"
	},
	{
		gambar: "https://images.unsplash.com/photo-1507842217343-583bb7270b66?w=1920&h=1080&fit=crop",
		label: "Mengembangkan <span class='text-brand-secondary-dark'>ilmu pengetahuan </span> secara berkelanjutan dengan pendekatan ilmiah dan berbasis nilai Islam.",
		cta_label: "Keilmuan",
		cta_url: "/program",
		colour: "#4FC3F7"
	},
	{
		gambar: "https://images.unsplash.com/photo-1591604129939-f1efa4d9f7fa?w=1920&h=1080&fit=crop",
		label: "Menjadikan <span class='text-brand-secondary'>Al-Qur'an dan Hadis </span> sebagai landasan utama dalam berpikir, bersikap, dan bertindak.",
		cta_label: "Keislaman",
		cta_url: "/program",
		colour: "#81D4FA"
	},
	{
		gambar: "https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=1920&h=1080&fit=crop",
		label: "Mendorong <span class='text-brand-secondary-light'>kreativitas dan pembaruan </span>dalam pendidikan, penelitian, dan pengabdian kepada masyarakat.",
		cta_label: "Inovasi",
		cta_url: "/profile",
		colour: "#B3E5FC"
	},
	{
		gambar: "https://images.unsplash.com/photo-1559027615-cd4628902d4a?w=1920&h=1080&fit=crop",
		label: "Mengedepankan <span class='text-brand-primary-light'>kebermanfaatan, pemberdayaan, dan keadilan sosial</span> bagi masyarakat luas.",
		cta_label: "Kepedulian Sosial",
		cta_url: "/profile",
		colour: "#4CAF50"
	},
	{
		gambar: "https://images.unsplash.com/photo-1531482615713-2afd69097998?w=1920&h=1080&fit=crop",
		label: "Mengembangkan <span class='text-brand-accent-orange'>kerja sama </span>dengan berbagai pihak untuk memperluas dampak dan keberlanjutan program yayasan.",
		cta_label: "Kolaborasi",
		cta_url: "/profile",
		colour: "#FFD180"
	}
];

// 3. Autoplay delay
const autoplayDelay = 6000;
---

<div
	id="carousel-container"
	class="w-full h-[95svh] md:h-[91svh] relative overflow-hidden"
	aria-roledescription="carousel"
>
	<!-- Background slides container -->
	<div class="overflow-hidden w-full h-full absolute inset-0">
		<div id="carousel-track" class="flex h-full">
			{
				slides.map((slide) => (
					<div
						class="carousel-slide w-full h-full flex-shrink-0 relative"
						role="group"
						aria-roledescription="slide"
					>
						<img
							src={slide.gambar}
							alt={slide.cta_label}
							class="w-full absolute h-full object-cover pointer-events-none"
							loading="lazy"
						/>
						<!-- Gradient overlay untuk kontras yang lebih baik -->
						<div class="absolute inset-0 bg-gradient-to-br from-brand-primary/80 via-brand-primary/70 to-brand-primary-darker/80"></div>
					</div>
				))
			}
		</div>
	</div>

	<!-- Fixed content overlay -->
	<div class="absolute inset-0 flex flex-col gap-4 md:gap-6 justify-center items-start w-full h-full p-6 md:p-12 lg:px-16 xl:px-24  z-10 max-w-4xl pointer-events-none">
		<!-- Text container dengan animasi -->
		<div id="text-container" class="text-left pointer-events-auto flex flex-col gap-3">
			<!-- CTA Label Badge -->
			<div
				id="slide-cta-label"
				class="inline-flex items-center gap-2 text-white/90 text-sm md:text-base font-semibold px-3 py-1.5 md:px-4 md:py-2 bg-white/20 backdrop-blur-sm rounded-full border border-white/30 w-fit"
			>
				<span id="cta-dot-indicator" class="w-2 h-2 rounded-full animate-pulse" style="background-color: #FFD700;"></span>
				<span id="cta-label-text">{slides[0].cta_label}</span>
			</div>
			<!-- Main Label -->
			<div
				id="slide-text"
				set:html={slides[0].label}
				class="text-white text-xl md:text-2xl lg:text-4xl leading-tight text-left font-bold drop-shadow-lg"
			></div>
		</div>

		<!-- Single CTA Button -->
		<button
			onclick="window.location.href='/program'"
			class="flex items-center gap-2 text-white text-sm md:text-base font-medium md:px-6 md:py-3 px-4 py-2 border-2 border-white hover:bg-white/10 active:scale-95 transition-all duration-200 cursor-pointer rounded-lg pointer-events-auto"
		>
			Lihat Program
			<ArrowUpRight class="md:w-5 md:h-5 w-4 h-4" />
		</button>
	</div>
</div>

<style>
	/* Smooth transition untuk background slides */
	#carousel-track {
		transition: transform 0.7s ease-in-out;
	}

	/* Animasi untuk text */
	#slide-text, #slide-cta-label {
		transition: opacity 0.3s ease-out, transform 0.3s ease-out;
	}
</style>

<script define:vars={{ autoplayDelay }}>
	const slidesData = [
		{
			label: "Menjunjung tinggi <span class='text-brand-accent-gold'>kejujuran, amanah, dan tanggung jawab </span> dalam setiap aktivitas kelembagaan.",
			cta_label: "Integritas",
			colour: "#FFD700"
		},
		{
			label: "Mengembangkan <span class='text-brand-secondary-dark'>ilmu pengetahuan </span> secara berkelanjutan dengan pendekatan ilmiah dan berbasis nilai Islam.",
			cta_label: "Keilmuan",
			colour: "#4FC3F7"
		},
		{
			label: "Menjadikan <span class='text-brand-secondary'>Al-Qur'an dan Hadis </span> sebagai landasan utama dalam berpikir, bersikap, dan bertindak.",
			cta_label: "Keislaman",
			colour: "#81D4FA"
		},
		{
			label: "Mendorong <span class='text-brand-secondary-light'>kreativitas dan pembaruan </span>dalam pendidikan, penelitian, dan pengabdian kepada masyarakat.",
			cta_label: "Inovasi",
			colour: "#B3E5FC"
		},
		{
			label: "Mengedepankan <span class='text-brand-primary-light'>kebermanfaatan, pemberdayaan, dan keadilan sosial</span> bagi masyarakat luas.",
			cta_label: "Kepedulian Sosial",
			colour: "#4CAF50"
		},
		{
			label: "Mengembangkan <span class='text-brand-accent-orange'>kerja sama </span>dengan berbagai pihak untuk memperluas dampak dan keberlanjutan program yayasan.",
			cta_label: "Kolaborasi",
			colour: "#FFD180"
		}
	];

	document.addEventListener("DOMContentLoaded", () => {
		const track = document.getElementById("carousel-track");
		const textElement = document.getElementById("slide-text");
		if (!track || !textElement) return;

		const slides = Array.from(track.querySelectorAll(".carousel-slide"));
		if (slides.length === 0) return;

		// --- Setup untuk Looping ---
		const slidesCount = slides.length;
		const firstClone = slides[0].cloneNode(true);
		const lastClone = slides[slidesCount - 1].cloneNode(true);
		track.appendChild(firstClone);
		track.prepend(lastClone);

		// --- Inisialisasi State ---
		let currentIndex = 1;
		let animationFrameId;
		let lastTime = performance.now();
		let timeSinceLastSlide = 0;
		let isTransitioning = false;

		const setPositionByIndex = () => {
			const slideWidth = slides[0].offsetWidth;
			const currentTranslate = -currentIndex * slideWidth;
			track.style.transform = `translateX(${currentTranslate}px)`;
		};

		const setInitialPosition = () => {
			track.style.transition = "none";
			setPositionByIndex();
		};

		setInitialPosition();

		// Update text dengan animasi
		const ctaLabelElement = document.getElementById("slide-cta-label");
		const updateText = (index) => {
			const actualIndex = index === 0 ? slidesCount - 1 : (index === slidesCount + 1 ? 0 : index - 1);
			const slideData = slidesData[actualIndex];
			
			// Fade out
			textElement.style.opacity = "0";
			textElement.style.transform = "translateY(20px)";
			if (ctaLabelElement) {
				ctaLabelElement.style.opacity = "0";
				ctaLabelElement.style.transform = "translateY(-10px)";
			}
			
			setTimeout(() => {
				textElement.innerHTML = slideData.label;
				if (ctaLabelElement) {
					const badge = document.getElementById('cta-label-text');
					if (badge) badge.textContent = slideData.cta_label;				
				// Update warna dot indicator
				const dotIndicator = document.getElementById('cta-dot-indicator');
				if (dotIndicator) dotIndicator.style.backgroundColor = slideData.colour;				}
				// Fade in
				textElement.style.opacity = "1";
				textElement.style.transform = "translateY(0)";
				if (ctaLabelElement) {
					ctaLabelElement.style.opacity = "1";
					ctaLabelElement.style.transform = "translateY(0)";
				}
			}, 300);
		};

		// --- Logika Looping & Autoplay ---
		const checkIndex = () => {
			if (currentIndex === 0) {
				currentIndex = slidesCount;
				setInitialPosition();
			} else if (currentIndex === slidesCount + 1) {
				currentIndex = 1;
				setInitialPosition();
			}
			
			// Update text saat slide berubah
			updateText(currentIndex);
			isTransitioning = false;
		};

		const startAutoPlay = () => {
			stopAutoPlay();
			lastTime = performance.now();
			animationFrameId = requestAnimationFrame(autoPlayLoop);
		};

		const stopAutoPlay = () => {
			cancelAnimationFrame(animationFrameId);
		};

		const autoPlayLoop = (timestamp) => {
			if (isTransitioning) {
				animationFrameId = requestAnimationFrame(autoPlayLoop);
				return;
			}

			const deltaTime = timestamp - lastTime;
			lastTime = timestamp;
			timeSinceLastSlide += deltaTime;

			if (timeSinceLastSlide >= autoplayDelay) {
				isTransitioning = true;
				currentIndex++;
				track.style.transition = "transform 0.7s ease-in-out";
				setPositionByIndex();
				timeSinceLastSlide = 0;
			}

			animationFrameId = requestAnimationFrame(autoPlayLoop);
		};

		// Handle visibility change
		document.addEventListener("visibilitychange", () => {
			if (document.hidden) {
				stopAutoPlay();
			} else {
				startAutoPlay();
			}
		});

		// Attach event listeners
		track.addEventListener("transitionend", checkIndex);
		window.addEventListener("resize", setInitialPosition);

		// Initialize text animation
		textElement.style.transition = "opacity 0.3s ease-out, transform 0.3s ease-out";
		textElement.style.opacity = "1";
		if (ctaLabelElement) {
			ctaLabelElement.style.transition = "opacity 0.3s ease-out, transform 0.3s ease-out";
			ctaLabelElement.style.opacity = "1";
		}

		startAutoPlay();
	});
</script>