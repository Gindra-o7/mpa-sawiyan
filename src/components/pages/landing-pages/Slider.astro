---
import { ArrowUpRight } from "@lucide/astro";

// 1. Mendefinisikan tipe data untuk setiap slide menggunakan TypeScript
export interface Slide {
	gambar: string;
	label: string;
	cta_label: string;
	cta_url: string;
}

// 2. Data slides hardcoded dengan tema kemanusiaan, agama, dan sosial
const slides: Slide[] = [
	{
		gambar: "https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=1920&h=1080&fit=crop",
		label: "Memberi <span class='text-[#FFD700]'>Harapan</span> untuk Mereka yang Membutuhkan",
		cta_label: "Jadi Relawan",
		cta_url: "/program"
	},
	{
		gambar: "https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=1920&h=1080&fit=crop",
		label: "Program <span class='text-[#81D4FA]'>Kemanusiaan</span> yang Membawa Perubahan",
		cta_label: "Lihat Kegiatan",
		cta_url: "/program"
	},
	{
		gambar: "https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=1920&h=1080&fit=crop",
		label: "Menebar <span class='text-[#FFD180]'>Rahmat</span> melalui Kebaikan Bersama",
		cta_label: "Berbagi Kebaikan",
		cta_url: "/program"
	},
	{
		gambar: "https://images.unsplash.com/photo-1469571486292-0ba58a3f068b?w=1920&h=1080&fit=crop",
		label: "Yayasan <span class='text-[#FFD700]'>Sawiyan</span>: Berpijak pada Iman, Bergerak untuk Umat",
		cta_label: "Pelajari Lebih Lanjut",
		cta_url: "/profile"
	}
];

// 3. Autoplay delay
const autoplayDelay = 6000;
---

<div
	id="carousel-container"
	class="w-full h-[95svh] md:h-[91svh] relative overflow-hidden"
	aria-roledescription="carousel"
>
	<!-- Background slides container -->
	<div class="overflow-hidden w-full h-full absolute inset-0">
		<div id="carousel-track" class="flex h-full">
			{
				slides.map((slide) => (
					<div
						class="carousel-slide w-full h-full flex-shrink-0 relative"
						role="group"
						aria-roledescription="slide"
					>
						<img
							src={slide.gambar}
							alt={slide.cta_label}
							class="w-full absolute h-full object-cover pointer-events-none"
							loading="lazy"
						/>
						<!-- Gradient overlay untuk kontras yang lebih baik -->
						<div class="absolute inset-0 bg-gradient-to-br from-[#388E3C]/80 via-[#388E3C]/70 to-[#1B5E20]/80"></div>
					</div>
				))
			}
		</div>
	</div>

	<!-- Fixed content overlay -->
	<div class="absolute inset-0 flex flex-col gap-4 md:gap-6 justify-center items-start w-full h-full p-6 md:p-12 lg:px-16 xl:px-24  z-10 max-w-4xl pointer-events-none">
		<!-- Text container dengan animasi -->
		<div id="text-container" class="text-left pointer-events-auto">
			<div
				id="slide-text"
				set:html={slides[0].label}
				class="text-white text-2xl md:text-4xl lg:text-5xl leading-tight text-left font-bold drop-shadow-lg"
			></div>
		</div>

		<!-- Single CTA Button -->
		<button
			onclick="window.location.href='/program'"
			class="flex items-center gap-2 text-white text-sm md:text-base font-medium md:px-6 md:py-3 px-4 py-2 border-2 border-white hover:bg-white/10 active:scale-95 transition-all duration-200 cursor-pointer rounded-lg pointer-events-auto"
		>
			Lihat Program
			<ArrowUpRight class="md:w-5 md:h-5 w-4 h-4" />
		</button>
	</div>
</div>

<style>
	/* Smooth transition untuk background slides */
	#carousel-track {
		transition: transform 0.7s ease-in-out;
	}

	/* Animasi untuk text */
	#slide-text {
		transition: opacity 0.3s ease-out, transform 0.3s ease-out;
	}
</style>

<script define:vars={{ autoplayDelay }}>
	const slidesData = [
		"Memberi <span class='text-[#FFD700]'>Harapan</span> untuk Mereka yang Membutuhkan",
		"Program <span class='text-[#81D4FA]'>Kemanusiaan</span> yang Membawa Perubahan",
		"Menebar <span class='text-[#FFD180]'>Rahmat</span> melalui Kebaikan Bersama",
		"Yayasan <span class='text-[#FFD700]'>Sawiyan</span>: Berpijak pada Iman, Bergerak untuk Umat"
	];

	document.addEventListener("DOMContentLoaded", () => {
		const track = document.getElementById("carousel-track");
		const textElement = document.getElementById("slide-text");
		if (!track || !textElement) return;

		const slides = Array.from(track.querySelectorAll(".carousel-slide"));
		if (slides.length === 0) return;

		// --- Setup untuk Looping ---
		const slidesCount = slides.length;
		const firstClone = slides[0].cloneNode(true);
		const lastClone = slides[slidesCount - 1].cloneNode(true);
		track.appendChild(firstClone);
		track.prepend(lastClone);

		// --- Inisialisasi State ---
		let currentIndex = 1;
		let animationFrameId;
		let lastTime = performance.now();
		let timeSinceLastSlide = 0;
		let isTransitioning = false;

		const setPositionByIndex = () => {
			const slideWidth = slides[0].offsetWidth;
			const currentTranslate = -currentIndex * slideWidth;
			track.style.transform = `translateX(${currentTranslate}px)`;
		};

		const setInitialPosition = () => {
			track.style.transition = "none";
			setPositionByIndex();
		};

		setInitialPosition();

		// Update text dengan animasi
		const updateText = (index) => {
			const actualIndex = index === 0 ? slidesCount - 1 : (index === slidesCount + 1 ? 0 : index - 1);
			const text = slidesData[actualIndex];
			
			// Fade out
			textElement.style.opacity = "0";
			textElement.style.transform = "translateY(20px)";
			
			setTimeout(() => {
				textElement.innerHTML = text;
				// Fade in
				textElement.style.opacity = "1";
				textElement.style.transform = "translateY(0)";
			}, 300);
		};

		// --- Logika Looping & Autoplay ---
		const checkIndex = () => {
			if (currentIndex === 0) {
				currentIndex = slidesCount;
				setInitialPosition();
			} else if (currentIndex === slidesCount + 1) {
				currentIndex = 1;
				setInitialPosition();
			}
			
			// Update text saat slide berubah
			updateText(currentIndex);
			isTransitioning = false;
		};

		const startAutoPlay = () => {
			stopAutoPlay();
			lastTime = performance.now();
			animationFrameId = requestAnimationFrame(autoPlayLoop);
		};

		const stopAutoPlay = () => {
			cancelAnimationFrame(animationFrameId);
		};

		const autoPlayLoop = (timestamp) => {
			if (isTransitioning) {
				animationFrameId = requestAnimationFrame(autoPlayLoop);
				return;
			}

			const deltaTime = timestamp - lastTime;
			lastTime = timestamp;
			timeSinceLastSlide += deltaTime;

			if (timeSinceLastSlide >= autoplayDelay) {
				isTransitioning = true;
				currentIndex++;
				track.style.transition = "transform 0.7s ease-in-out";
				setPositionByIndex();
				timeSinceLastSlide = 0;
			}

			animationFrameId = requestAnimationFrame(autoPlayLoop);
		};

		// Handle visibility change
		document.addEventListener("visibilitychange", () => {
			if (document.hidden) {
				stopAutoPlay();
			} else {
				startAutoPlay();
			}
		});

		// Attach event listeners
		track.addEventListener("transitionend", checkIndex);
		window.addEventListener("resize", setInitialPosition);

		// Initialize text animation
		textElement.style.transition = "opacity 0.3s ease-out, transform 0.3s ease-out";
		textElement.style.opacity = "1";

		startAutoPlay();
	});
</script>